<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<title>pia ‚Äì Voice Call</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--bg2:#111119;--bg3:#1a1a28;--bg4:#222233;
  --text:#e8e8f0;--text2:#aaa;--text3:#666;
  --accent:#6c5ce7;--accent2:#a29bfe;
  --green:#00d26a;--green-dim:#00b85c;--green-bg:rgba(0,210,106,.1);
  --yellow:#ffd32a;--yellow-bg:rgba(255,211,42,.1);
  --red:#ff4757;--red-bg:rgba(255,71,87,.1);
  --blue:#4af;--blue-bg:rgba(68,170,255,.08);
  --border:#1e1e2e;
  --radius:16px;--radius-sm:10px;
  /* Car mode overrides (applied via .car-mode class) */
  --cm-font:18px;--cm-btn:72px;--cm-gap:12px;
}
html{height:100%;overflow:hidden}
body{
  font-family:-apple-system,'SF Pro Text',system-ui,'Segoe UI',sans-serif;
  background:var(--bg);color:var(--text);height:100dvh;height:100vh;
  display:flex;flex-direction:column;overflow:hidden;
  -webkit-font-smoothing:antialiased;
}

/* ================================================================
   STATUS BAR ‚Äî full-width color-coded strip
   ================================================================ */
.status-bar{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:8px 16px;min-height:48px;gap:10px;
  background:var(--bg2);border-bottom:1px solid var(--border);
  transition:background .4s,border-color .4s;z-index:10;
}
.status-bar.st-listening{background:rgba(0,210,106,.07);border-bottom-color:var(--green)}
.status-bar.st-speaking{background:rgba(68,170,255,.07);border-bottom-color:var(--blue)}
.status-bar.st-connecting{background:rgba(255,211,42,.07);border-bottom-color:var(--yellow)}
.status-bar.st-error{background:rgba(255,71,87,.07);border-bottom-color:var(--red)}

.sb-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.sb-logo{font-size:15px;font-weight:700;white-space:nowrap;opacity:.7}
.sb-status{
  display:flex;align-items:center;gap:6px;
  font-size:13px;font-weight:600;letter-spacing:.3px;
  color:var(--text3);transition:color .3s;white-space:nowrap;
}
.sb-dot{width:8px;height:8px;border-radius:50%;background:currentColor;flex-shrink:0;transition:all .3s}
.st-listening .sb-status{color:var(--green)}
.st-listening .sb-dot{animation:breathe 2s ease-in-out infinite}
.st-speaking .sb-status{color:var(--blue)}
.st-speaking .sb-dot{animation:pulse-fast .5s ease-in-out infinite}
.st-connecting .sb-status{color:var(--yellow)}
.st-connecting .sb-dot{animation:spin 1s linear infinite;border-radius:3px;width:8px;height:8px}
.st-error .sb-status{color:var(--red)}

.volume-wrap{width:48px;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;flex-shrink:0}
.volume-fill{height:100%;background:var(--green);transition:width 80ms;width:0;border-radius:2px}

.sb-right{display:flex;gap:6px;align-items:center;flex-shrink:0}
.sb-btn{
  width:40px;height:40px;border-radius:12px;border:none;
  background:var(--bg3);color:var(--text2);font-size:17px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;-webkit-tap-highlight-color:transparent;
}
.sb-btn:active{transform:scale(.9)}
.sb-btn.muted{background:var(--red-bg);color:var(--red)}

@keyframes breathe{0%,100%{opacity:.35}50%{opacity:1}}
@keyframes pulse-fast{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.6)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ================================================================
   SETTINGS BOTTOM SHEET
   ================================================================ */
.settings-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.55);z-index:100;animation:fadeIn .15s;
}
.settings-overlay.visible{display:flex;align-items:flex-end;justify-content:center}
.settings-sheet{
  background:var(--bg2);border-radius:20px 20px 0 0;
  width:100%;max-width:500px;padding:24px 20px calc(24px + env(safe-area-inset-bottom,0px));
  animation:slideUp .25s ease;
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.ss-handle{width:36px;height:4px;border-radius:2px;background:var(--bg4);margin:0 auto 20px}
.ss-title{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:12px;font-weight:600}
.ss-row{
  display:flex;align-items:center;gap:14px;padding:14px 16px;
  border-radius:var(--radius-sm);cursor:pointer;transition:all .12s;
  border:1.5px solid transparent;margin-bottom:4px;
}
.ss-row:active{transform:scale(.98)}
.ss-row:hover{background:var(--bg3)}
.ss-row.active{background:rgba(108,92,231,.12);border-color:var(--accent)}
.ss-row .ss-icon{font-size:24px;width:36px;text-align:center}
.ss-row .ss-name{font-weight:600;font-size:15px}
.ss-row .ss-desc{font-size:12px;color:var(--text3);margin-top:1px}
.ss-row-group{display:flex;gap:8px;margin-top:4px}
.ss-action{
  flex:1;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--border);
  background:var(--bg);color:var(--text2);font-size:13px;text-align:center;
  cursor:pointer;transition:all .12s;
}
.ss-action:active{transform:scale(.97);background:var(--bg3)}

/* Toggle switch */
.ss-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:var(--radius-sm)}
.ss-toggle-row .ss-label{font-size:14px;font-weight:500}
.ss-toggle-row .ss-sublabel{font-size:11px;color:var(--text3);margin-top:2px}
.toggle-track{
  width:50px;height:28px;border-radius:14px;background:var(--bg4);
  position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;
}
.toggle-track.on{background:var(--green)}
.toggle-knob{
  position:absolute;top:3px;left:3px;width:22px;height:22px;
  border-radius:50%;background:#fff;transition:transform .2s;
}
.toggle-track.on .toggle-knob{transform:translateX(22px)}

/* ================================================================
   TRANSCRIPT
   ================================================================ */
.debug-panel{
  max-height:200px;overflow-y:auto;background:#0a0a0a;border-bottom:1px solid var(--bg3);
  font-family:monospace;font-size:11px;padding:8px;line-height:1.5;color:#ccc;
}
.debug-panel.hidden{display:none}
.debug-row{padding:1px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.transcript{
  flex:1;overflow-y:auto;overflow-x:hidden;padding:14px 12px 8px;
  display:flex;flex-direction:column;gap:6px;
  -webkit-overflow-scrolling:touch;
}
.transcript::-webkit-scrollbar{width:3px}
.transcript::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}

.placeholder-msg{
  text-align:center;color:var(--text3);padding:48px 24px;
  font-size:15px;line-height:1.8;flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
}
.placeholder-msg .big-icon{font-size:56px;margin-bottom:16px;display:block;opacity:.4}

/* Messages */
.msg-row{display:flex;flex-direction:column;max-width:85%;animation:msgIn .2s ease}
.msg-row.user{align-self:flex-end;align-items:flex-end}
.msg-row.agent{align-self:flex-start;align-items:flex-start}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.msg-bubble{
  padding:10px 14px;font-size:15px;line-height:1.55;
  border-radius:var(--radius);word-wrap:break-word;white-space:pre-wrap;
}
.msg-row.user .msg-bubble{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg-row.agent .msg-bubble{background:var(--bg3);color:var(--text);border-bottom-left-radius:4px}
.msg-row.tentative .msg-bubble{opacity:.45}
.msg-row.user.tentative .msg-bubble{background:rgba(108,92,231,.35)}
.msg-time{font-size:10px;color:var(--text3);margin-top:2px;padding:0 4px}

/* Tool cards inline */
.tool-card{
  align-self:center;max-width:94%;width:100%;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--radius-sm);overflow:hidden;
  animation:msgIn .2s ease;margin:4px 0;
}
.tool-header{
  display:flex;align-items:center;gap:8px;padding:10px 14px;
  cursor:pointer;user-select:none;font-size:13px;
  -webkit-tap-highlight-color:transparent;
}
.tool-icon{font-size:16px;flex-shrink:0}
.tool-label{flex:1;min-width:0}
.tool-name{font-weight:600;color:var(--text);font-size:13px}
.tool-query{color:var(--text3);font-size:12px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tool-status{font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;white-space:nowrap}
.tool-status.pending{background:var(--yellow-bg);color:var(--yellow)}
.tool-status.done{background:var(--green-bg);color:var(--green)}
.tool-status.error{background:var(--red-bg);color:var(--red)}
.tool-chevron{color:var(--text3);transition:transform .2s;font-size:11px}
.tool-card.expanded .tool-chevron{transform:rotate(180deg)}
.tool-body{display:none;padding:0 14px 12px;font-size:12px;color:var(--text2);line-height:1.6;border-top:1px solid var(--border)}
.tool-card.expanded .tool-body{display:block;padding-top:10px}
.tool-result{
  background:var(--bg);border-radius:8px;padding:10px 12px;margin-top:6px;
  white-space:pre-wrap;word-break:break-word;max-height:300px;overflow-y:auto;
  font-family:'SF Mono',ui-monospace,monospace;font-size:11px;
}
.tool-spinner{
  width:14px;height:14px;border:2px solid var(--bg4);border-top-color:var(--yellow);
  border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;
}

/* System messages */
.system-msg{
  align-self:center;text-align:center;
  font-size:12px;color:var(--text3);padding:6px 16px;
  animation:msgIn .2s ease;
}

/* ================================================================
   BOTTOM CONTROLS (ALWAYS PINNED)
   ================================================================ */
.controls{
  flex-shrink:0;padding:12px 16px max(14px, env(safe-area-inset-bottom,0px));
  border-top:1px solid var(--border);background:var(--bg2);
}
.ctl-row{display:flex;gap:10px;align-items:center;justify-content:center;max-width:700px;margin:0 auto}
.text-input{
  flex:1;padding:12px 18px;border-radius:24px;
  border:1px solid var(--border);background:var(--bg);color:var(--text);
  font-size:15px;font-family:inherit;outline:none;
  resize:none;max-height:100px;min-height:48px;line-height:1.4;
  transition:border-color .2s;
}
.text-input:focus{border-color:var(--accent)}
.text-input::placeholder{color:var(--text3)}
.ctl-btn{
  width:48px;height:48px;border-radius:50%;border:none;
  font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0;-webkit-tap-highlight-color:transparent;
}
.ctl-btn:active{transform:scale(.88)}
.ctl-send{background:var(--accent);color:#fff}
.ctl-call.start{background:var(--green);color:#fff}
.ctl-call.start:hover{background:var(--green-dim)}
.ctl-call.end{background:var(--red);color:#fff}
.ctl-call.connecting{background:var(--yellow);color:#000;pointer-events:none}

/* ================================================================
   CAR MODE  üöó
   ================================================================ */
body.car-mode{background:#050508}

/* Status bar: taller, bolder */
.car-mode .status-bar{min-height:60px;padding:10px 20px}
.car-mode .sb-logo{font-size:18px;opacity:.8}
.car-mode .sb-status{font-size:17px;font-weight:700;letter-spacing:.5px;gap:8px}
.car-mode .sb-dot{width:12px;height:12px}
.car-mode .volume-wrap{width:72px;height:6px}
.car-mode .sb-btn{width:52px;height:52px;border-radius:14px;font-size:22px}

/* Transcript: large font, more padding */
.car-mode .transcript{padding:16px 14px 8px;gap:10px}
.car-mode .msg-bubble{font-size:18px;padding:14px 18px;line-height:1.6;border-radius:20px}
.car-mode .msg-row{max-width:92%}
.car-mode .msg-time{font-size:12px}
.car-mode .system-msg{font-size:14px}
.car-mode .tool-card{border-radius:14px}
.car-mode .tool-header{padding:14px 18px;font-size:15px}
.car-mode .tool-name{font-size:15px}
.car-mode .tool-query{font-size:14px}
.car-mode .tool-status{font-size:13px;padding:4px 10px}

/* Controls: huge buttons, hide text input, thumb-friendly */
.car-mode .controls{padding:16px 20px max(20px, env(safe-area-inset-bottom,0px))}
.car-mode .text-input{display:none}
.car-mode .ctl-send{display:none}
.car-mode .ctl-row{gap:20px}
.car-mode .ctl-btn{width:var(--cm-btn);height:var(--cm-btn);font-size:30px;border-radius:50%}
.car-mode .ctl-call{width:88px;height:88px;font-size:38px}

/* Car mode: mic toggle is big & always visible */
.car-mode .car-mic{
  display:flex !important;
  width:var(--cm-btn);height:var(--cm-btn);border-radius:50%;
  border:none;font-size:30px;cursor:pointer;
  align-items:center;justify-content:center;
  transition:all .15s;-webkit-tap-highlight-color:transparent;
  background:var(--bg3);color:var(--text);
}
.car-mode .car-mic:active{transform:scale(.88)}
.car-mode .car-mic.muted{background:var(--red);color:#fff}

/* Car mode: speaker toggle */
.car-mode .car-spk{
  display:flex !important;
  width:60px;height:60px;border-radius:50%;
  border:none;font-size:24px;cursor:pointer;
  align-items:center;justify-content:center;
  transition:all .15s;-webkit-tap-highlight-color:transparent;
  background:var(--bg3);color:var(--text2);
}
.car-mode .car-spk:active{transform:scale(.88)}
.car-mode .car-spk.muted{background:var(--red-bg);color:var(--red)}

/* Car mode placeholder */
.car-mode .placeholder-msg{font-size:20px}
.car-mode .placeholder-msg .big-icon{font-size:72px}

/* ================================================================
   LANDSCAPE (car mount orientation)
   ================================================================ */
@media(orientation:landscape) and (max-height:500px){
  .status-bar{min-height:40px;padding:4px 16px}
  .sb-logo{font-size:13px}
  .transcript{padding:8px 12px 4px}
  .controls{padding:8px 16px max(8px, env(safe-area-inset-bottom,0px))}
  .ctl-btn{width:44px;height:44px;font-size:18px}

  /* Car mode landscape */
  .car-mode .status-bar{min-height:48px;padding:4px 20px}
  .car-mode .sb-status{font-size:15px}
  .car-mode .sb-btn{width:44px;height:44px;font-size:18px}
  .car-mode .msg-bubble{font-size:16px;padding:10px 14px}
  .car-mode .transcript{padding:8px 10px 4px;gap:6px}
  .car-mode .controls{padding:8px 16px max(8px, env(safe-area-inset-bottom,0px))}
  .car-mode .ctl-btn{width:56px;height:56px;font-size:24px}
  .car-mode .ctl-call{width:68px;height:68px;font-size:30px}
  .car-mode .car-mic{width:56px;height:56px;font-size:24px}
  .car-mode .car-spk{width:48px;height:48px;font-size:20px}
}

/* ================================================================
   SMALL PORTRAIT PHONE
   ================================================================ */
@media(max-width:500px) and (orientation:portrait){
  .status-bar{padding:8px 12px}
  .transcript{padding:12px 8px 6px}
  .msg-row{max-width:92%}
  .tool-card{max-width:98%}
  .controls{padding:10px 10px max(10px, env(safe-area-inset-bottom,0px))}
}
</style>
</head><body>

<!-- ====== STATUS BAR ====== -->
<div class="status-bar" id="statusBar">
  <div class="sb-left">
    <span class="sb-logo">üîÆ pia</span>
    <div class="sb-status" id="statusLabel"><span class="sb-dot" id="statusDot"></span> Offline</div>
    <div class="volume-wrap"><div class="volume-fill" id="vol"></div></div>
  </div>
  <div class="sb-right">
    <button class="sb-btn" id="muteBtn" onclick="toggleMute()" title="Mute mic" style="display:none">üé§</button>
    <button class="sb-btn" id="speakerBtn" onclick="toggleSpeaker()" title="Speaker" style="display:none">üîä</button>
    <button class="sb-btn" id="debugBtn" onclick="toggleDebug()" title="Debug">üêõ</button>
    <button class="sb-btn" id="settingsBtn" onclick="toggleSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
</div>

<!-- ====== SETTINGS OVERLAY ====== -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="settings-sheet" onclick="event.stopPropagation()">
    <div class="ss-handle"></div>

    <div class="ss-title">Mode</div>
    <div class="ss-toggle-row" onclick="toggleCarMode()">
      <div>
        <div class="ss-label">üöó Car Mode</div>
        <div class="ss-sublabel">Large buttons, auto-connect, no typing</div>
      </div>
      <div class="toggle-track" id="carToggle"><div class="toggle-knob"></div></div>
    </div>
    <div class="ss-toggle-row" onclick="toggleAutoConnect()">
      <div>
        <div class="ss-label">‚ö° Auto-Connect</div>
        <div class="ss-sublabel">Connect automatically on page load</div>
      </div>
      <div class="toggle-track" id="autoConnToggle"><div class="toggle-knob"></div></div>
    </div>

    <div class="ss-title" style="margin-top:20px">Voice</div>
    <div id="voiceOptions">
      <div class="ss-row active" data-voice="nPczCjzI2devNBz1zQrb" data-name="Brian" onclick="selectVoice(this)">
        <span class="ss-icon">üéôÔ∏è</span>
        <div><div class="ss-name">Brian</div><div class="ss-desc">Warm, natural</div></div>
      </div>
      <div class="ss-row" data-voice="cjVigY5qzO86Huf0OWal" data-name="Eric" onclick="selectVoice(this)">
        <span class="ss-icon">üó£Ô∏è</span>
        <div><div class="ss-name">Eric</div><div class="ss-desc">Clear, professional</div></div>
      </div>
      <div class="ss-row" data-voice="Xb7hH8MSUJpSbSDYk0k2" data-name="Alice" onclick="selectVoice(this)">
        <span class="ss-icon">üíé</span>
        <div><div class="ss-name">Alice</div><div class="ss-desc">Elegant female</div></div>
      </div>
    </div>

    <div class="ss-title" style="margin-top:20px">Transcript</div>
    <div class="ss-row-group">
      <button class="ss-action" onclick="exportTranscript('copy')">üìã Copy</button>
      <button class="ss-action" onclick="exportTranscript('download')">üíæ Download</button>
    </div>
  </div>
</div>

<!-- ====== TRANSCRIPT ====== -->
<div id="debugPanel" class="debug-panel hidden"></div>
<div class="transcript" id="transcript">
  <div class="placeholder-msg" id="placeholder">
    <span class="big-icon">üîÆ</span>
    Tap the green button to start a voice call.<br>
    Or type a message below.<br>
    <span style="font-size:12px;opacity:.5;margin-top:10px;display:inline-block">
      Transcript, tool calls &amp; results appear here live.
    </span>
  </div>
</div>

<!-- ====== BOTTOM CONTROLS ====== -->
<div class="controls" id="controlBar">
  <div class="ctl-row" id="ctlRow">
    <!-- Car-mode only: big mic (hidden normally) -->
    <button class="car-mic" id="carMic" onclick="toggleMute()" style="display:none">üé§</button>
    <button class="car-spk" id="carSpk" onclick="toggleSpeaker()" style="display:none">üîä</button>

    <!-- Text input (hidden in car mode) -->
    <textarea class="text-input" id="textInput" placeholder="Type a message‚Ä¶" rows="1"
      oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
    <button class="ctl-btn ctl-send" onclick="sendText()" title="Send">‚Üë</button>

    <!-- Call button (always visible) -->
    <button class="ctl-btn ctl-call start" id="callBtn" onclick="toggleCall()">üìû</button>
  </div>
</div>

<script type="module">
import { Conversation } from 'https://cdn.jsdelivr.net/npm/@elevenlabs/client@latest/+esm';

const $ = id => document.getElementById(id);
const serverBase = new URLSearchParams(location.search).get('s') || location.origin;

let conversation = null;
window.conversation = null;
let isActive = false;

const transcriptEl = $('transcript');
let currentUserMsg = null;
let currentAgentMsg = null;

let sessionMessages = [];
let conversationFacts = [];
let lastAgentMode = 'listening';
let agentSpeakingStarted = 0;
let sessionStartTime = null;
let memoryContext = null;

const transcriptLog = [];
window.transcriptLog = transcriptLog;

const toolCards = new Map();
let _seenTier2 = new Set();

// ========== CAR MODE + AUTO-CONNECT STATE ==========
let carMode = localStorage.getItem('pia-car-mode') === 'true';
let autoConnect = localStorage.getItem('pia-auto-connect') === 'true';

function applyCarMode() {
  document.body.classList.toggle('car-mode', carMode);
  const t = $('carToggle');
  if (t) t.classList.toggle('on', carMode);
  // If car mode is on, also enable auto-connect
  if (carMode && !autoConnect) {
    autoConnect = true;
    localStorage.setItem('pia-auto-connect', 'true');
    const at = $('autoConnToggle');
    if (at) at.classList.toggle('on', true);
  }
}

function toggleCarMode() {
  carMode = !carMode;
  localStorage.setItem('pia-car-mode', carMode ? 'true' : 'false');
  applyCarMode();
}

function toggleAutoConnect() {
  autoConnect = !autoConnect;
  localStorage.setItem('pia-auto-connect', autoConnect ? 'true' : 'false');
  const t = $('autoConnToggle');
  if (t) t.classList.toggle('on', autoConnect);
}

// Apply on load
applyCarMode();
if ($('autoConnToggle')) $('autoConnToggle').classList.toggle('on', autoConnect);

// ========== UTILITY ==========
function timeNow() {
  return new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
}
function escHtml(s) {
  const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
}
function scrollToBottom() {
  requestAnimationFrame(() => { transcriptEl.scrollTop = transcriptEl.scrollHeight; });
}
function removePlaceholder() {
  const ph = $('placeholder'); if (ph) ph.remove();
}

// ========== STATUS ==========
function setStatus(state, label) {
  const bar = $('statusBar');
  bar.className = 'status-bar st-' + state;
  const lbl = $('statusLabel');
  lbl.innerHTML = `<span class="sb-dot" id="statusDot"></span> ${escHtml(label)}`;
}

// ========== MESSAGES ==========
function addMsg(role, text, tentative = false) {
  removePlaceholder();
  const row = document.createElement('div');
  row.className = `msg-row ${role}${tentative ? ' tentative' : ''}`;
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  if (!tentative) {
    const t = document.createElement('div'); t.className = 'msg-time'; t.textContent = timeNow();
    row.appendChild(t);
  }
  transcriptEl.appendChild(row);
  scrollToBottom();
  if (!tentative) {
    transcriptLog.push({ time: new Date().toISOString(), role: role === 'user' ? 'user' : 'pia', text, type: 'voice' });
    fetch('/api/transcript-log', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(transcriptLog[transcriptLog.length-1]) }).catch(()=>{});
  }
  return row;
}

function updateOrCreateMsg(role, text, tentative = false) {
  const cur = role === 'user' ? currentUserMsg : currentAgentMsg;
  if (cur && cur.classList.contains('tentative')) {
    cur.querySelector('.msg-bubble').textContent = text;
    if (!tentative) {
      cur.classList.remove('tentative');
      const t = document.createElement('div'); t.className = 'msg-time'; t.textContent = timeNow();
      cur.appendChild(t);
      if (role === 'user') currentUserMsg = null; else currentAgentMsg = null;
      transcriptLog.push({ time: new Date().toISOString(), role: role === 'user' ? 'user' : 'pia', text, type: 'voice' });
      fetch('/api/transcript-log', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(transcriptLog[transcriptLog.length-1]) }).catch(()=>{});
    }
    scrollToBottom();
  } else {
    const msg = addMsg(role, text, tentative);
    if (role === 'user') currentUserMsg = msg; else currentAgentMsg = msg;
  }
}

function addSystemMsg(icon, text) {
  removePlaceholder();
  const el = document.createElement('div');
  el.className = 'system-msg';
  el.innerHTML = `<span>${icon}</span> ${escHtml(text)}`;
  transcriptEl.appendChild(el);
  scrollToBottom();
}

// ========== TOOL CARDS ==========
function addToolCard(id, icon, name, query, status) {
  window.addDebugLog('tool', `${icon} ${name}: ${query || 'started'} [${status}]`);
  removePlaceholder();
  const card = document.createElement('div');
  card.className = 'tool-card'; card.dataset.id = id;
  const sc = status === 'done' ? 'done' : status === 'error' ? 'error' : 'pending';
  const sl = sc === 'done' ? '‚úÖ Done' : sc === 'error' ? '‚ùå Error' : '‚è≥ Running';
  card.innerHTML = `
    <div class="tool-header" onclick="this.parentElement.classList.toggle('expanded')">
      <span class="tool-icon">${icon}</span>
      <div class="tool-label"><div class="tool-name">${escHtml(name)}</div><div class="tool-query">${escHtml(query||'')}</div></div>
      ${sc==='pending'?'<div class="tool-spinner"></div>':''}
      <span class="tool-status ${sc}">${sl}</span>
      <span class="tool-chevron">‚ñº</span>
    </div>
    <div class="tool-body"><div class="tool-result" id="tool-result-${id}">Waiting for result‚Ä¶</div></div>`;
  transcriptEl.appendChild(card);
  toolCards.set(id, card);
  scrollToBottom();
  return card;
}

function updateToolCard(id, result, status, elapsed) {
  window.addDebugLog('tool', `‚úÖ ${id}: ${(result||'').substring(0,60)} [${elapsed}]`);
  const card = toolCards.get(id); if (!card) return;
  const se = card.querySelector('.tool-status');
  const re = card.querySelector('.tool-result');
  const sp = card.querySelector('.tool-spinner');
  if (sp) sp.remove();
  if (status === 'done') { se.className = 'tool-status done'; se.textContent = elapsed ? `‚úÖ ${elapsed}` : '‚úÖ Done'; }
  else if (status === 'error') { se.className = 'tool-status error'; se.textContent = '‚ùå Error'; }
  if (result) { re.textContent = result.length > 2000 ? result.substring(0,2000)+'\n‚Ä¶(truncated)' : result; }
  if (result && result.length < 300) card.classList.add('expanded');
  scrollToBottom();
}

// ========== CALL ==========
async function toggleCall() {
  if (isActive) await endCall(); else await startCall();
}

async function startCall() {
  const btn = $('callBtn');
  btn.disabled = true;
  btn.className = 'ctl-btn ctl-call connecting'; btn.textContent = '‚è≥';
  setStatus('connecting', 'Connecting‚Ä¶');

  try {
    try {
      const mr = await fetch(serverBase + '/api/voice-memory/context');
      memoryContext = await mr.json();
    } catch(e) { memoryContext = null; }

    sessionMessages = [];
    sessionStartTime = new Date().toISOString();

    const resp = await fetch(serverBase + '/api/signed-url');
    const data = await resp.json();
    if (!data.signed_url) throw new Error('No signed URL returned');

    const sessionOverrides = {};
    if (selectedVoiceId && selectedVoiceId !== 'nPczCjzI2devNBz1zQrb') {
      sessionOverrides.tts = { voiceId: selectedVoiceId };
      addSystemMsg('üéôÔ∏è', `Voice: ${selectedVoiceName}`);
    }

    conversation = await Conversation.startSession({
      signedUrl: data.signed_url,
      connectionType: 'websocket',
      overrides: Object.keys(sessionOverrides).length > 0 ? sessionOverrides : undefined,

      clientTools: {
        get_current_time: async () => {
          const t0 = performance.now(); const cid = 'ct_'+Date.now();
          addToolCard(cid,'‚ö°','get_current_time','','pending');
          const now = new Date();
          const ts = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Macau'});
          const ds = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric',timeZone:'Asia/Macau'});
          const r = `Current time in Macau: ${ts}, ${ds}`;
          updateToolCard(cid,r,'done',Math.round(performance.now()-t0)+'ms');
          return r;
        },
        get_loaded_context: async () => {
          const t0 = performance.now(); const cid = 'glc_'+Date.now();
          addToolCard(cid,'üß†','get_loaded_context','','pending');
          const f = window._sessionContext || 'No context loaded yet';
          const r = typeof f === 'string' ? f : JSON.stringify(f);
          updateToolCard(cid,r,'done',Math.round(performance.now()-t0)+'ms');
          return r;
        },
        get_session_facts: async () => {
          const t0 = performance.now(); const cid = 'gsf_'+Date.now();
          addToolCard(cid,'üìã','get_session_facts','','pending');
          if (!conversationFacts||conversationFacts.length===0) {
            updateToolCard(cid,'No facts yet.','done',Math.round(performance.now()-t0)+'ms');
            return 'No facts from this session yet.';
          }
          const r = conversationFacts.map((f,i)=>`${i+1}. Q: "${f.query}" ‚Üí ${f.summary}`).join('\n');
          updateToolCard(cid,r,'done',Math.round(performance.now()-t0)+'ms');
          return r;
        }
      },

      onConnect: () => {
        window.conversation = conversation;
        setStatus('listening','Listening');
        removePlaceholder();
        addSystemMsg('üîó','Voice session started');
        isActive = true;
        btn.className = 'ctl-btn ctl-call end'; btn.textContent = '‚èπ'; btn.disabled = false;
        // Show header controls
        $('muteBtn').style.display = 'flex';
        $('speakerBtn').style.display = 'flex';
        if (memoryContext && memoryContext.has_history) {
          addSystemMsg('üíæ',`Loaded ${memoryContext.recent_sessions.length} recent conversations`);
        }
        // Inject context
        (async()=>{
          try {
            const cr = await fetch('/api/voice-context');
            const cd = await cr.json();
            if (cd.context && window.conversation) {
              window._sessionContext = cd.context;
              window.conversation.sendContextualUpdate?.(`SESSION CONTEXT (your memory from today):\n${cd.context}`);
              addSystemMsg('üß†',`Memory loaded (${cd.context.length} chars)`);
            }
          } catch(e){}
        })();
      },

      onDisconnect: () => {
        addSystemMsg('üì¥','Voice session ended');
        saveSessionMemory();
        saveVoiceSession();
        resetUI();
      },

      onMessage: (msg) => {
        if (msg.source === 'user') {
          if (msg.message && msg.message.includes('Background job completed')) return;
          updateOrCreateMsg('user', msg.message, !msg.isFinal);
          if (msg.isFinal) {
            sessionMessages.push({timestamp:new Date().toISOString(),role:'user',content:msg.message});
            window.addDebugLog('user', msg.message.substring(0, 80));
          }
        } else if (msg.source === 'ai') {
          updateOrCreateMsg('agent', msg.message, !msg.isFinal);
          if (msg.isFinal) {
            sessionMessages.push({timestamp:new Date().toISOString(),role:'assistant',content:msg.message});
            window.addDebugLog('agent', msg.message.substring(0, 80));
          }
        }
      },

      onError: (err) => {
        setStatus('error','Error');
        addSystemMsg('‚ùå', err.message||JSON.stringify(err));
      },

      onModeChange: (mode) => {
        if (mode.mode === 'speaking') {
          setStatus('speaking','Speaking');
          lastAgentMode = 'speaking';
          agentSpeakingStarted = Date.now();
        } else if (mode.mode === 'listening') {
          setStatus('listening','Listening');
          if (lastAgentMode === 'speaking' && (Date.now()-agentSpeakingStarted) < 3000) reinforceContext();
          lastAgentMode = 'listening';
        }
      },

      onStatusChange: () => {},
    });

  } catch (err) {
    setStatus('error','Failed');
    addSystemMsg('‚ùå','Connection failed: '+err.message);
    btn.disabled = false;
    btn.className = 'ctl-btn ctl-call start'; btn.textContent = 'üìû';
  }
}

async function endCall() {
  if (conversation) { await conversation.endSession(); conversation = null; window.conversation = null; }
  saveSessionMemory(); resetUI();
}

function resetUI() {
  isActive = false;
  const btn = $('callBtn');
  btn.className = 'ctl-btn ctl-call start'; btn.textContent = 'üìû'; btn.disabled = false;
  $('muteBtn').style.display = 'none';
  $('speakerBtn').style.display = 'none';
  isMuted = false; isSpeakerMuted = false;
  $('carMic').classList.remove('muted'); $('carMic').textContent = 'üé§';
  $('carSpk').classList.remove('muted'); $('carSpk').textContent = 'üîä';
  setStatus('offline','Offline');
}

// ========== MUTE / SPEAKER ==========
let isMuted = false;
let isSpeakerMuted = false;

async function toggleMute() {
  if (!conversation) return;
  isMuted = !isMuted;
  // Update header button
  const hb = $('muteBtn');
  hb.textContent = isMuted ? 'üîá' : 'üé§';
  hb.classList.toggle('muted', isMuted);
  // Update car-mode button
  const cb = $('carMic');
  cb.textContent = isMuted ? 'üîá' : 'üé§';
  cb.classList.toggle('muted', isMuted);

  if (isMuted) await conversation.setVolume?.({volume:0});
  else await conversation.setVolume?.({volume:1});
  addSystemMsg(isMuted?'üîá':'üé§', isMuted?'Mic muted':'Mic on');
}

async function toggleSpeaker() {
  if (!conversation) return;
  isSpeakerMuted = !isSpeakerMuted;
  const hb = $('speakerBtn');
  hb.textContent = isSpeakerMuted ? 'üîà' : 'üîä';
  hb.classList.toggle('muted', isSpeakerMuted);
  const cb = $('carSpk');
  cb.textContent = isSpeakerMuted ? 'üîà' : 'üîä';
  cb.classList.toggle('muted', isSpeakerMuted);

  if (isSpeakerMuted) await conversation.setVolume?.({outputVolume:0});
  else await conversation.setVolume?.({outputVolume:1});
}

// ========== SETTINGS ==========
function toggleSettings() { $('settingsOverlay').classList.toggle('visible'); }
function closeSettingsOutside(e) { if (e.target === $('settingsOverlay')) toggleSettings(); }

// ========== VOICE ==========
let selectedVoiceId = 'nPczCjzI2devNBz1zQrb';
let selectedVoiceName = 'Brian';
function selectVoice(el) {
  document.querySelectorAll('.ss-row[data-voice]').forEach(v=>v.classList.remove('active'));
  el.classList.add('active');
  selectedVoiceId = el.dataset.voice;
  selectedVoiceName = el.dataset.name;
  if (conversation) addSystemMsg('üîÑ',`Voice ‚Üí ${selectedVoiceName} (reconnect to apply)`);
}

// ========== VOLUME MONITOR ==========
setInterval(()=>{
  if (conversation && isActive) { $('vol').style.width = ((conversation.getInputVolume?.()||0)*100)+'%'; }
  else { $('vol').style.width = '0%'; }
},100);

// Keepalive
setInterval(()=>{ if (window.conversation&&isActive) try{window.conversation.sendUserActivity?.();}catch(e){} },30000);

// ========== TEXT INPUT ==========
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText();} }

async function sendText() {
  const inp = $('textInput'); const txt = inp.value.trim(); if(!txt) return;
  inp.value=''; inp.style.height='auto';
  addMsg('user',txt);
  try {
    const r1 = await fetch('/api/el-tool',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:txt})});
    const d1 = await r1.json(); addMsg('agent',d1.result);
    await new Promise(r=>setTimeout(r,3000));
    const r2 = await fetch('/api/el-check-results'); const d2 = await r2.json();
    if(d2.result&&!d2.result.includes('Still working')) addMsg('agent',d2.result);
  } catch(e){ addMsg('agent','Error: '+e.message); }
}

// ========== EXPORT ==========
async function exportTranscript(mode) {
  try {
    const r = await fetch('/api/transcript-export'); const d = await r.json(); const t = d.transcript;
    if(mode==='copy'){await navigator.clipboard.writeText(t);addSystemMsg('‚úÖ','Copied');}
    else{const b=new Blob([t],{type:'text/markdown'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`pia-${new Date().toISOString().slice(0,16)}.md`;a.click();URL.revokeObjectURL(u);addSystemMsg('üíæ','Downloaded');}
  }catch(e){addSystemMsg('‚ùå','Export failed');}
}

// ========== SESSION MEMORY ==========
async function saveSessionMemory() {
  if(sessionMessages.length===0&&transcriptLog.length===0) return;
  try{await fetch(serverBase+'/api/voice-memory/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:sessionMessages,metadata:{startTime:sessionStartTime,agent_id:'agent_2701khdf1eqke629dd7qwp2681ts'}})});}catch(e){}
  try{await fetch('/api/transcript-save-memory',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({entries:transcriptLog.length})});}catch(e){}
}

// ========== CONTEXT MEMORY ==========
function addFact(q,r){const s=r.length>300?r.substring(0,300)+'...':r;conversationFacts.push({query:q,summary:s,time:new Date().toLocaleTimeString()});if(conversationFacts.length>10)conversationFacts.shift();}

function reinforceContext(){
  if(!window.conversation||conversationFacts.length===0) return;
  const fs=conversationFacts.map((f,i)=>`${i+1}. [${f.time}] Q: "${f.query}" ‚Üí ${f.summary}`).join('\n');
  try{window.conversation.sendContextualUpdate?.(`CONTEXT REFRESH:\n${fs}\n\nUse this for follow-ups.`);}catch(e){}
}
setInterval(()=>{if(window.conversation&&conversationFacts.length>0&&isActive)reinforceContext();},120000);

async function saveVoiceSession(){
  if(conversationFacts.length===0)return;
  try{await fetch('/api/voice-save-session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({facts:conversationFacts,transcript:sessionMessages.slice(-20),duration:Math.round((Date.now()-(agentSpeakingStarted||Date.now()))/1000)})});}catch(e){}
}

// ========== BACKGROUND JOBS ==========
const announcedJobs = new Set();
const knownJobIds = new Set();

async function updateJobs(){
  try{
    const r=await fetch('/api/jobs-status');const d=await r.json();
    if(!d.jobs||d.jobs.length===0) return;
    for(const j of d.jobs){
      if(!knownJobIds.has(j.id)){
        knownJobIds.add(j.id);
        addToolCard(j.id,j.tier===2?'üöÄ':'üîß',j.tier===2?'Quick Tool':'Background Job',j.query||'Processing‚Ä¶',j.status);
      }
      if(j.status==='done'&&!announcedJobs.has(j.id)){
        announcedJobs.add(j.id);
        const el=j.completedAt&&j.timestamp?Math.round((new Date(j.completedAt)-new Date(j.timestamp))/1000)+'s':'';
        updateToolCard(j.id,j.result||'No result','done',el);
        addFact(j.query,j.result);
        announceJobResult(j);
      }
    }
    try{
      const t2r=await fetch('/api/tier2-status');const t2d=await t2r.json();
      for(const ev of(t2d.events||[])){
        const k=`${ev.tool}_${ev.ts}_${ev.status}`;
        if(!_seenTier2.has(k)){
          _seenTier2.add(k);
          if(ev.status==='running'){const ci='t2_'+ev.ts;if(!toolCards.has(ci))addToolCard(ci,'üöÄ',ev.tool,ev.query||'','pending');}
          else if(ev.status==='done'){updateToolCard('t2_'+ev.ts, ev.result || `Done in ${ev.elapsed}s`,'done',ev.elapsed+'s');}
        }
      }
    }catch(e){}
  }catch(e){}
}

function announceJobResult(job){
  if(window.conversation){
    try{
      window.conversation.sendContextualUpdate?.(`BACKGROUND JOB COMPLETED for "${job.query}". Result: ${job.result}`);
      setTimeout(()=>{window.conversation.sendUserMessage?.('Background job completed. Relay the results from the contextual update to me now.');},500);
    }catch(e){}
  }
  try{const c=new AudioContext();const o=c.createOscillator();const g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;g.gain.value=0.1;o.start();o.stop(c.currentTime+0.15);}catch(e){}
}

setInterval(updateJobs,1500);
updateJobs();

// ========== AUTO-CONNECT ==========
if (autoConnect) {
  // Small delay to let page settle
  setTimeout(() => {
    if (!isActive) {
      addSystemMsg('‚ö°','Auto-connecting‚Ä¶');
      startCall();
    }
  }, 800);
}

// ========== URL PARAM: ?car=1 ==========
if (new URLSearchParams(location.search).get('car') === '1' && !carMode) {
  carMode = true;
  localStorage.setItem('pia-car-mode', 'true');
  autoConnect = true;
  localStorage.setItem('pia-auto-connect', 'true');
  applyCarMode();
  if (!isActive) { setTimeout(()=>{ addSystemMsg('üöó','Car mode ‚Äî auto-connecting‚Ä¶'); startCall(); },800); }
}

// ========== EXPOSE GLOBALS ==========
window.toggleCall=toggleCall;window.toggleMute=toggleMute;window.toggleSpeaker=toggleSpeaker;
window.toggleSettings=toggleSettings;window.closeSettingsOutside=closeSettingsOutside;
window.selectVoice=selectVoice;window.sendText=sendText;window.handleKey=handleKey;
window.autoResize=autoResize;window.exportTranscript=exportTranscript;
window.toggleCarMode=toggleCarMode;window.toggleAutoConnect=toggleAutoConnect;
window.addFact=addFact;window.reinforceContext=reinforceContext;window.saveVoiceSession=saveVoiceSession;
// ========== DEBUG PANEL ==========
const debugLogs = [];
window.addDebugLog = function(type, msg) {
  console.log(`[debug:${type}] ${msg}`);
  const entry = { time: timeNow(), type, msg };
  debugLogs.push(entry);
  if (debugLogs.length > 100) debugLogs.shift();
  const panel = $('debugPanel');
  if (panel && !panel.classList.contains('hidden')) {
    const row = document.createElement('div');
    row.className = 'debug-row';
    row.innerHTML = `<span style="color:#888">${entry.time}</span> <span style="color:#6c5ce7">[${type}]</span> ${escHtml(msg)}`;
    panel.appendChild(row);
    panel.scrollTop = panel.scrollHeight;
  }
};

function toggleDebug() {
  const panel = $('debugPanel');
  if (!panel) return;
  panel.classList.toggle('hidden');
  if (!panel.classList.contains('hidden')) {
    panel.innerHTML = '';
    debugLogs.forEach(e => {
      const row = document.createElement('div');
      row.className = 'debug-row';
      row.innerHTML = `<span style="color:#888">${e.time}</span> <span style="color:#6c5ce7">[${e.type}]</span> ${escHtml(e.msg)}`;
      panel.appendChild(row);
    });
    panel.scrollTop = panel.scrollHeight;
  }
}
window.toggleDebug = toggleDebug;
window.renderArtifact=function(){};
</script>
</body></html>
